<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>AI Desktop Pet</title>
    <style>
        /* ğŸŒŸ 1. ç½‘é¡µæ•´ä½“ï¼šé“ºæ»¡å…¨å±ï¼Œå¹¶è®¾ä¸ºåŸºç¡€æ‹–æ‹½å±‚ */
        html,
        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background-color: transparent;
            -webkit-app-region: drag;
            /* å…¨å±€é»˜è®¤å¯æ‹–æ‹½ */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* ğŸŒŸ 2. Live2D ç”»å¸ƒï¼šå®‰å®‰é™é™å½“åº•å›¾ï¼Œåˆ æ‰å¤šä½™çš„ drag å±æ€§ */
        #canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        /* ğŸŒŸ 3. å¯¹è¯æ°”æ³¡ï¼šå…æ‹–æ‹½ç‰¹æƒ */
        #chat-bubble {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 12px 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            font-size: 14px;
            color: #333;
            max-width: 250px;
            word-wrap: break-word;
            z-index: 999;

            /* äº¤äº’å…ƒç´ å¿…é¡»å£°æ˜ no-drag å’Œ pointer-events */
            -webkit-app-region: no-drag;
            pointer-events: auto;

            display: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        /* ğŸŒŸ 4. è¾“å…¥æ¡†åŒºåŸŸï¼šå…æ‹–æ‹½ç‰¹æƒï¼Œå¼ºè¡Œå¤ºå›ç‚¹å‡»æƒ */
        #input-area {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 5px 10px;
            display: flex;
            gap: 5px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);

            /* äº¤äº’å…ƒç´ å¿…é¡»å£°æ˜ no-drag å’Œ pointer-events */
            -webkit-app-region: no-drag;
            pointer-events: auto;
        }

        #input-area input {
            border: none;
            outline: none;
            background: transparent;
            width: 160px;
        }

        #input-area button {
            border: none;
            background: #ffb6c1;
            color: white;
            border-radius: 15px;
            padding: 5px 15px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/live2dcubismcore@1.0.2/live2dcubismcore.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@6.5.2/dist/browser/pixi.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display/dist/cubism4.min.js"></script>
</head>

<body>

    <div id="chat-bubble"></div>
    <div id="input-area">
        <input type="text" id="user-input" placeholder="å’Œæˆ‘è¯´è¯´è¯å§..." onkeypress="handleEnter(event)" />
        <button onclick="sendMessage()">å‘é€</button>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        // æš´éœ²ç»™æ’ä»¶
        window.PIXI = PIXI;

        // --- å‰åç«¯é€šä¿¡é€»è¾‘ ---
        // ğŸŒŸ æ–°å¢ï¼šåœ¨å¤–é¢å®šä¸€ä¸ªå…¨å±€å˜é‡ï¼Œç”¨æ¥å­˜å®šæ—¶å™¨
        let bubbleTimer = null;

        async function sendMessage() {
            const inputElement = document.getElementById('user-input');
            const bubbleElement = document.getElementById('chat-bubble');
            const message = inputElement.value.trim();

            if (!message) return;

            // ğŸŒŸ ç»†èŠ‚ï¼šå¦‚æœç”¨æˆ·è¿ç»­å‘æ¶ˆæ¯ï¼Œå…ˆæ‰“æ–­ä¹‹å‰çš„å€’è®¡æ—¶ï¼Œé˜²æ­¢æ°”æ³¡é—ªçƒ
            if (bubbleTimer) {
                clearTimeout(bubbleTimer);
                bubbleTimer = null;
            }

            inputElement.value = '';

            // å±•ç°æ°”æ³¡ï¼Œå¹¶è§¦å‘æ¸ç°åŠ¨ç”»
            bubbleElement.style.display = 'block';
            setTimeout(() => { bubbleElement.style.opacity = 1; }, 10);
            bubbleElement.innerText = "æ­£åœ¨æ€è€ƒä¸­...";

            try {
                // å‘¼å«åç«¯
                const response = await fetch('http://localhost:8000/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: message })
                });

                const data = await response.json();
                bubbleElement.innerText = data.reply;

                // ğŸŒŸ æ ¸å¿ƒï¼šè®¾ä¸‹ 5 ç§’çš„å€’è®¡æ—¶
                bubbleTimer = setTimeout(() => {
                    // 1. å…ˆè§¦å‘ CSS çš„é€æ˜åº¦æ¸å˜ (0.5ç§’)
                    bubbleElement.style.opacity = 0;

                    // 2. ç­‰æ¸å˜åŠ¨ç”»æ’­å®Œï¼Œå†æŠŠå…ƒç´ å½»åº•éšè—ï¼Œä¸æŒ¡è§†çº¿
                    setTimeout(() => {
                        if (bubbleElement.style.opacity == 0) {
                            bubbleElement.style.display = 'none';
                        }
                    }, 500);
                }, 5000); // 5000 æ¯«ç§’ = 5 ç§’

            } catch (error) {
                bubbleElement.innerText = "å•Šå“¦ï¼Œè¿æ¥ä¸åˆ°å¤§è„‘(åç«¯æœåŠ¡å™¨)äº†~";
                console.error(error);
            }
        }

        // ç»‘å®šå›è½¦é”®å‘é€
        function handleEnter(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // --- Live2D åˆå§‹åŒ–é€»è¾‘ ---
        async function initPet() {
            const app = new PIXI.Application({
                view: document.getElementById('canvas'),
                transparent: true,
                autoDensity: true,
                resizeTo: window
            });

            // const modelUrl = '../../assets/koharu/koharu.model3.json';
            const modelUrl = '../../assets/haruto/haruto.model3.json';

            try {
                const live2dModel = await PIXI.live2d.Live2DModel.from(modelUrl);
                app.stage.addChild(live2dModel);

                live2dModel.scale.set(0.15);
                live2dModel.x = app.screen.width / 2 - live2dModel.width / 2;
                live2dModel.y = app.screen.height / 2 - live2dModel.height / 2;

                // é¼ æ ‡è§†çº¿è·Ÿéš
                document.body.addEventListener('mousemove', (event) => {
                    live2dModel.focus(event.clientX, event.clientY);
                });

            } catch (error) {
                console.error("æ¨¡å‹åŠ è½½å¤±è´¥äº†ï¼", error);
            }
        }

        initPet();
    </script>
</body>

</html>